/*! litegraph 03-02-2015 */
function LGraphShader(){this.addInput("Base color","vec4"),this.properties={value:1},this.editable={property:"value",type:"number"},this.size=[200,200],this.shader_piece=ShaderConstructor}function LGraphCamToPixelWS(){this.addOutput("Camera To Pixel","vec3"),this.shader_piece=PCameraToPixelWS}function LGraphConstant(){this.addOutput("value","number",{number:1}),this.properties={value:1},this.editable={property:"value",type:"number"},this.shader_piece=new PConstant("float")}function LGraphConstVec2(){this.addOutput("value","vec2",{vec2:1}),this.properties={v1:1,v2:1},this.shader_piece=new PConstant("vec2")}function LGraphConstVec3(){this.addOutput("value","vec3",{vec3:1}),this.properties={value:"1.0,1.0,1.0"},this.editable={property:"value",type:"vec3"},this.shader_piece=new PConstant("vec3")}function LGraphConstVec4(){this.addOutput("value","vec4",{vec4:1}),this.properties={value:"1.0,1.0,1.0,1.0"},this.editable={property:"value",type:"vec4"},this.shader_piece=new PConstant("vec4")}function LGraphMixer(){this.addOutput("Result","vec4",{vec4:1,vec3:1}),this.addInput("A","vec3",{vec4:1,vec3:1,"float":1}),this.addInput("B","vec3",{vec4:1,vec3:1,"float":1}),this.addInput("alpha","float",{"float":1}),this.shader_piece=PMixer}function LGraphOperation(){this.addOutput("Result","vec4",{vec4:1,vec3:1}),this.addInput("A","vec3",{vec4:1,vec3:1,"float":1}),this.addInput("B","vec3",{vec4:1,vec3:1,"float":1}),this.shader_piece=POperation}function LGraphPixelNormalWS(){this.addOutput("Pixel Normal","vec3"),this.shader_piece=PPixelNormalWS}function LGraphTexturePreview(){this.addInput("Texture","Texture",{Texture:1,Vec3:1,Vec4:1}),this.properties={flipY:!1},this.size=[LGraphTexture.image_preview_size,LGraphTexture.image_preview_size]}function LGraphReflect(){this.addOutput("reflect vector","vec3"),this.addInput("normal","vec3"),this.addInput("vector","vec3"),this.shader_piece=PReflect}function LGraphTexture(){this.addOutput("Texture","Texture",{Texture:1}),this.addOutput("Color","vec4",{vec3:1,vec4:1}),this.addOutput("R","R"),this.addOutput("G","G"),this.addOutput("B","B"),this.addOutput("A","A"),this.addInput("UVs","vec2"),this.properties={name:""},this.size=[LGraphTexture.image_preview_size,LGraphTexture.image_preview_size],this.shader_piece=PTextureSample,"undefined"!=typeof gl&&gl.textures["default"]&&(this.properties.name="default",this._drop_texture=gl.textures["default"])}function LGraphCubemap(){this.addOutput("Cubemap","Cubemap"),this.addOutput("Color","vec4",{vec3:1,vec4:1}),this.addInput("vec3","vec3"),this.properties={name:""},this.size=[LGraphTexture.image_preview_size,LGraphTexture.image_preview_size],this.shader_piece=PTextureSampleCube,"undefined"!=typeof gl&&gl.textures.cubemap&&(this.properties.name="cubemap",this._drop_texture=gl.textures.cubemap)}function LGraphUVs(){this.addOutput("UVs","vec2",{vec2:1}),this.properties={UTiling:1,VTiling:1},this.shader_piece=PUVs}LGraphShader.title="ShaderMain",LGraphShader.desc="Shader Main Node",LGraphShader.prototype.setValue=function(){},LGraphShader.prototype.onExecute=function(){this.processInputCode()},LGraphShader.prototype.onDrawBackground=function(){},LGraphShader.prototype.onWidget=function(){},LGraphShader.prototype.processInputCode=function(){var a=this.getInputCode(0),b=this.shader_piece.createShader(a,"");this.graph.shader_output=b;var c=this.graph.findNodesByType("texture/textureSample");this.graph.shader_textures=[];for(var d=0;d<c.length;++d)this.graph.shader_textures.push(c[d].properties.name)},LiteGraph.registerNodeType("core/ShaderNode",LGraphShader),LGraphCamToPixelWS.title="CameraToPixelWS",LGraphCamToPixelWS.desc="The vector from camera to pixel",LGraphCamToPixelWS.prototype.onExecute=function(){this.codes=this.shader_piece.getCode()},LiteGraph.registerNodeType("texture/CameraToPixelWS",LGraphCamToPixelWS),LGraphConstant.title="Number",LGraphConstant.desc="Constant value",LGraphConstant.prototype.setValue=function(a){"string"==typeof a&&(a=parseFloat(a)),this.properties.value=a,this.setDirtyCanvas(!0)},LGraphConstant.prototype.onExecute=function(){this.codes=this.shader_piece.getCode("float_"+this.id,this.properties.value,PConstant.FRAGMENT),this.setOutputData(0,parseFloat(this.properties.value))},LGraphConstant.prototype.onDrawBackground=function(){this.outputs[0].label=this.properties.value.toFixed(3)},LGraphConstant.prototype.onWidget=function(a,b){"value"==b.name&&this.setValue(b.value)},LiteGraph.registerNodeType("constants/Number",LGraphConstant),LGraphConstVec2.title="ConstVec2",LGraphConstVec2.desc="Constant vector2",LGraphConstVec2.prototype.setFloatValue=function(a,b){"string"==typeof b&&(b=parseFloat(b)),a=b},LGraphConstVec2.prototype.setValue=function(a,b){this.setFloatValue(this.properties.v1,a),this.setFloatValue(this.properties.v2,b),this.setDirtyCanvas(!0)},LGraphConstVec2.prototype.onExecute=function(){this.codes=this.shader_piece.getCode("vec2_"+this.id,this.valueToString(),PConstant.FRAGMENT)},LGraphConstVec2.prototype.onDrawBackground=function(){this.outputs[0].label=this.valueToString()},LGraphConstVec2.prototype.valueToString=function(){return"vec2("+this.properties.v1+","+this.properties.v2+")"},LiteGraph.registerNodeType("constants/ConstVec2",LGraphConstVec2),LGraphConstVec3.title="ConstVec3",LGraphConstVec3.desc="Constant vector3",LGraphConstVec3.prototype.setValue=function(){"string"==typeof v&&(v=parseFloat(v)),this.properties.value=v,this.setDirtyCanvas(!0)},LGraphConstVec3.prototype.onExecute=function(){this.codes=this.shader_piece.getCode("vec3_"+this.id,"vec3("+this.properties.value+")",PConstant.FRAGMENT)},LGraphConstVec3.prototype.onDrawBackground=function(){this.outputs[0].label=this.properties.value},LiteGraph.registerNodeType("constants/ConstVec3",LGraphConstVec3),LGraphConstVec4.title="ConstVec4",LGraphConstVec4.desc="Constant vector4",LGraphConstVec4.prototype.setValue=function(a){"string"==typeof a&&(a=parseFloat(a)),this.properties.value=a,this.setDirtyCanvas(!0)},LGraphConstVec4.prototype.onExecute=function(){this.codes=this.shader_piece.getCode("vec4_"+this.id,"vec4("+this.properties.value+")",PConstant.FRAGMENT)},LGraphConstVec4.prototype.onDrawBackground=function(){this.outputs[0].label=this.properties.value},LiteGraph.registerNodeType("constants/ConstVec4",LGraphConstVec4),LGraphMixer.title="Lerp",LGraphMixer.desc="Lerp between A and B",LGraphMixer.prototype.onExecute=function(){this.processInputCode()},LGraphMixer.prototype.processInputCode=function(){var a=this.getInputCode(0),b=this.getInputCode(1),b=this.getInputCode(1);this.codes=this.shader_piece.getCode("mixed_"+this.id,a[1].getOutputVar(),b[1].getOutputVar(),"0.5"),this.codes[0].merge(a[0]),this.codes[1].merge(a[1]),this.codes[0].merge(b[0]),this.codes[1].merge(b[1])},LiteGraph.registerNodeType("texture/Lerp",LGraphMixer),LGraphOperation.title="operation",LGraphOperation.desc="operation between A and B",LGraphOperation.prototype.onExecute=function(){this.processInputCode()},LGraphOperation.prototype.processInputCode=function(){var a=this.getInputCode(0),b=this.getInputCode(1);this.codes=this.shader_piece.getCode("result_"+this.id,"+",a[1].getOutputVar(),b[1].getOutputVar()),this.codes[0].merge(a[0]),this.codes[1].merge(a[1]),this.codes[0].merge(b[0]),this.codes[1].merge(b[1])},LiteGraph.registerNodeType("texture/Operation",LGraphOperation),LGraphPixelNormalWS.title="PixelNormalWS",LGraphPixelNormalWS.desc="The normal in world coordinates",LGraphPixelNormalWS.prototype.onExecute=function(){this.codes=this.shader_piece.getCode()},LiteGraph.registerNodeType("texture/PixelNormalWS",LGraphPixelNormalWS),LGraphTexturePreview.title="Preview",LGraphTexturePreview.desc="Show a texture in the graph canvas",LGraphTexturePreview.prototype.onDrawBackground=function(a){if(!this.flags.collapsed){var b=this.getInputData(0);if(b){var c=null;c=!b.handle&&a.webgl?b:LGraphTexture.generateLowResTexturePreview(b),a.save(),this.properties.flipY&&(a.translate(0,this.size[1]),a.scale(1,-1)),a.drawImage(c,0+.5*LiteGraph.NODE_COLLAPSED_RADIUS,0+.5*LiteGraph.NODE_COLLAPSED_RADIUS,this.size[0]-LiteGraph.NODE_COLLAPSED_RADIUS,this.size[1]-LiteGraph.NODE_COLLAPSED_RADIUS),a.restore()}}},LiteGraph.registerNodeType("texture/preview",LGraphTexturePreview),window.LGraphTexturePreview=LGraphTexturePreview,LGraphReflect.title="ReflectVector",LGraphReflect.desc="To reflect a vector3",LGraphReflect.prototype.onExecute=function(){this.processInputCode()},LGraphReflect.prototype.processInputCode=function(){var a=this.getInputCode(0),b=this.getInputCode(1);this.codes=this.shader_piece.getCode("reflect_"+this.id,b[1].getOutputVar(),a[1].getOutputVar()),this.codes[0].merge(a[0]),this.codes[1].merge(a[1]),this.codes[0].merge(b[0]),this.codes[1].merge(b[1])},LiteGraph.registerNodeType("texture/reflect",LGraphReflect),LGraphTexture.title="textureSample",LGraphTexture.desc="textureSample",LGraphTexture.widgets_info={name:{widget:"texture"}},LGraphTexture.textures_container={},LGraphTexture.loadTextureCallback=null,LGraphTexture.image_preview_size=256,LGraphTexture.PASS_THROUGH=1,LGraphTexture.COPY=2,LGraphTexture.LOW=3,LGraphTexture.HIGH=4,LGraphTexture.REUSE=5,LGraphTexture.DEFAULT=2,LGraphTexture.MODE_VALUES={"pass through":LGraphTexture.PASS_THROUGH,copy:LGraphTexture.COPY,low:LGraphTexture.LOW,high:LGraphTexture.HIGH,reuse:LGraphTexture.REUSE,"default":LGraphTexture.DEFAULT},LGraphTexture.getTexture=function(a){var b=LGraphTexture.textures_container||gl.textures;if(!b)throw"Cannot load texture, container of textures not found";var c=b[a];if(!c&&a&&":"!=a[0]){if(LGraphTexture.loadTextureCallback){var d=LGraphTexture.loadTextureCallback;return d&&d(a),null}var e=a;"http://"==e.substr(0,7)&&LiteGraph.proxy&&(e=LiteGraph.proxy+e.substr(7)),c=b[a]=GL.Texture.fromURL(e,{})}return c},LGraphTexture.getTargetTexture=function(a,b,c){if(!a)throw"LGraphTexture.getTargetTexture expects a reference texture";var d=null;switch(c){case LGraphTexture.LOW:d=gl.UNSIGNED_BYTE;break;case LGraphTexture.HIGH:d=gl.HIGH_PRECISION_FORMAT;break;case LGraphTexture.REUSE:return a;case LGraphTexture.COPY:default:d=a?a.type:gl.UNSIGNED_BYTE}return b&&b.width==a.width&&b.height==a.height&&b.type==d||(b=new GL.Texture(a.width,a.height,{type:d,format:gl.RGBA,filter:gl.LINEAR})),b},LGraphTexture.getNoiseTexture=function(){if(this._noise_texture)return this._noise_texture;for(var a=new Uint8Array(1048576),b=0;1048576>b;++b)a[b]=255*Math.random();var c=GL.Texture.fromMemory(512,512,a,{format:gl.RGBA,wrap:gl.REPEAT,filter:gl.NEAREST});return this._noise_texture=c,c},LGraphTexture.prototype.onDropFile=function(a,b,c){if(console.log([a,b,c]),a){var d=null,e=b.split(".")[0];if("string"==typeof a)gl.textures[e]=d=GL.Texture.fromURL(a);else if(-1!=b.toLowerCase().indexOf(".dds"))d=GL.Texture.fromDDSInMemory(a);else{var f=new Blob([c]),g=URL.createObjectURL(f);d=GL.Texture.fromURL(g)}this._drop_texture=d,this.properties.name=e}else this._drop_texture=null,this.properties.name=""},LGraphTexture.prototype.getExtraMenuOptions=function(){var a=this;if(this._drop_texture)return[{content:"Clear",callback:function(){a._drop_texture=null,a.properties.name=""}}]},LGraphTexture.prototype.onExecute=function(){if(this.processInputCode(),this._drop_texture)return void this.setOutputData(0,this._drop_texture);if(this.properties.name){var a=LGraphTexture.getTexture(this.properties.name);a&&(this._last_tex=a,this.setOutputData(0,a))}},LGraphTexture.prototype.onDrawBackground=function(a){if(!(this.flags.collapsed||this.size[1]<=20)){if(this._drop_texture&&a.webgl)return void a.drawImage(this._drop_texture,0,0,this.size[0],this.size[1]);if(this._last_preview_tex!=this._last_tex)if(a.webgl)this._canvas=this._last_tex;else{var b=LGraphTexture.generateLowResTexturePreview(this._last_tex);if(!b)return;this._last_preview_tex=this._last_tex,this._canvas=cloneCanvas(b)}this._canvas&&(a.save(),a.webgl||(a.translate(0,this.size[1]),a.scale(1,-1)),a.drawImage(this._canvas,0,0,this.size[0],this.size[1]),a.restore())}},LGraphTexture.generateLowResTexturePreview=function(a){if(!a)return null;var b=LGraphTexture.image_preview_size,c=a;(a.width>b||a.height>b)&&(c=this._preview_temp_tex,this._preview_temp_tex||(c=new GL.Texture(b,b,{minFilter:gl.NEAREST}),this._preview_temp_tex=c),a.copyTo(c),a=c);var d=this._preview_canvas;return d||(d=createCanvas(b,b),this._preview_canvas=d),c&&c.toCanvas(d),d},LGraphTexture.prototype.processInputCode=function(){var a=this.getInputCode(0),b="u_"+(this.properties.name?this.properties.name:"default_name")+"_texture";this.codes=this.shader_piece.getCode("color_"+this.id,a[1].getOutputVar(),b),this.codes[0].merge(a[0]),this.codes[1].merge(a[1])},LiteGraph.registerNodeType("texture/textureSample",LGraphTexture),window.LGraphTexture=LGraphTexture,LGraphCubemap.title="textureSampleCube",LGraphCubemap.desc="textureSampleCube",LGraphCubemap.prototype.onDropFile=function(a,b){if(a){var c=b.split(".")[0];gl.textures[c]=this._drop_texture="string"==typeof a?GL.Texture.cubemapFromURL(a):GL.Texture.fromDDSInMemory(a),this.properties.name=c}else this._drop_texture=null,this.properties.name=""},LGraphCubemap.prototype.onExecute=function(){if(this.processInputCode(),this._drop_texture)return void this.setOutputData(0,this._drop_texture);if(this.properties.name){var a=LGraphTexture.getTexture(this.properties.name);a&&(this._last_tex=a,this.setOutputData(0,a))}},LGraphCubemap.prototype.onDrawBackground=function(a){if(!(this.flags.collapsed||this.size[1]<=20)&&a.webgl){var b=gl.meshes.cube;b||(b=gl.meshes.cube=GL.Mesh.cube({size:1}))}},LGraphCubemap.prototype.processInputCode=function(){var a=this.getInputCode(0),b="u_"+(this.properties.name?this.properties.name:"default_name")+"_texture";this.codes=this.shader_piece.getCode("color_"+this.id,a[1].getOutputVar(),b),this.codes[0].merge(a[0]),this.codes[1].merge(a[1])},LiteGraph.registerNodeType("texture/TextureSampleCube",LGraphCubemap),window.LGraphCubemap=LGraphCubemap,LGraphUVs.title="TextureCoords",LGraphUVs.desc="Texture coordinates",LGraphUVs.prototype.onExecute=function(){this.codes=this.shader_piece.getCode()},LGraphUVs.prototype.setFloatValue=function(a,b){"string"==typeof b&&(b=parseFloat(b)),a=b},LGraphUVs.prototype.setValue=function(a,b){this.setFloatValue(this.properties.UTiling,a),this.setFloatValue(this.properties.VTiling,b)},LiteGraph.registerNodeType("texture/TextureCoords",LGraphUVs);