/*! litegraph 03-02-2015 */
function LGraph(){LiteGraph.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear()}function LGraphCanvas(a,b,c){if("string"==typeof a&&(a=document.querySelector(a)),!a)throw"no canvas found";this.max_zoom=10,this.min_zoom=.1,b&&b.attachCanvas(this),this.setCanvas(a),this.clear(),c||this.startRendering()}function LGraphNode(){this._ctor()}function compareObjects(a,b){for(var c in a)if(a[c]!=b[c])return!1;return!0}function distance(a,b){return Math.sqrt((b[0]-a[0])*(b[0]-a[0])+(b[1]-a[1])*(b[1]-a[1]))}function colorToString(a){return"rgba("+Math.round(255*a[0]).toFixed()+","+Math.round(255*a[1]).toFixed()+","+Math.round(255*a[2]).toFixed()+","+(4==a.length?a[3].toFixed(2):"1.0")+")"}function isInsideRectangle(a,b,c,d,e,f){return a>c&&c+e>a&&b>d&&d+f>b?!0:!1}function growBounding(a,b,c){b<a[0]?a[0]=b:b>a[2]&&(a[2]=b),c<a[1]?a[1]=c:c>a[3]&&(a[3]=c)}function isInsideBounding(a,b){return a[0]<b[0][0]||a[1]<b[0][1]||a[0]>b[1][0]||a[1]>b[1][1]?!1:!0}function overlapBounding(a,b){return a[0]>b[2]||a[1]>b[3]||a[2]<b[0]||a[3]<b[1]?!1:!0}function hex2num(a){"#"==a.charAt(0)&&(a=a.slice(1)),a=a.toUpperCase();for(var b,c,d="0123456789ABCDEF",e=new Array(3),f=0,g=0;6>g;g+=2)b=d.indexOf(a.charAt(g)),c=d.indexOf(a.charAt(g+1)),e[f]=16*b+c,f++;return e}function num2hex(a){for(var b,c,d="0123456789ABCDEF",e="#",f=0;3>f;f++)b=a[f]/16,c=a[f]%16,e+=d.charAt(b)+d.charAt(c);return e}function CodePiece(){this.header={},this.body_hash={},this.body_ids=[],this.includes={},this.output_var="",this.scope=""}function PConstant(a,b){this.type=a,this.name=b,this.id="constant",this.includes={u_model:1,a_normal:1,v_normal:1}}LGraph.supported_types=["number","string","boolean"],LGraph.prototype.getSupportedTypes=function(){return this.supported_types||LGraph.supported_types},LGraph.STATUS_STOPPED=1,LGraph.STATUS_RUNNING=2,LGraph.prototype.clear=function(){this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this._nodes=[],this._nodes_by_id={},this.last_link_id=0,this.links={},this.iteration=0,this.config={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.starttime=0,this.global_inputs={},this.global_outputs={},this.debug=!0,this.change(),this.sendActionToCanvas("clear")},LGraph.prototype.attachCanvas=function(a){if(a.constructor!=LGraphCanvas)throw"attachCanvas expects a LGraphCanvas instance";a.graph&&a.graph!=this&&a.graph.detachCanvas(a),a.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(a)},LGraph.prototype.detachCanvas=function(a){var b=this.list_of_graphcanvas.indexOf(a);-1!=b&&(a.graph=null,this.list_of_graphcanvas.splice(b,1))},LGraph.prototype.start=function(a){if(this.status!=LGraph.STATUS_RUNNING){this.status=LGraph.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),a=a||1;var b=this;this.execution_timer_id=setInterval(function(){b.runStep(1)},a)}},LGraph.prototype.stop=function(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null,this.sendEventToAllNodes("onStop"))},LGraph.prototype.runStep=function(a){a=a||1;var b=LiteGraph.getTime();this.globaltime=.001*(b-this.starttime);try{for(var c=0;a>c;c++)this.sendEventToAllNodes("onExecute"),this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep();this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(d){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw d;LiteGraph.debug&&console.log("Error during execution: "+d),this.stop()}var e=LiteGraph.getTime()-b;0==e&&(e=1),this.elapsed_time=.001*e,this.globaltime+=.001*e,this.iteration+=1},LGraph.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder()},LGraph.prototype.computeExecutionOrder=function(){var a=[],b=[],c={},d={},e={};for(var f in this._nodes){var g=this._nodes[f];c[g.id]=g;var h=0;if(g.inputs)for(var i=0,j=g.inputs.length;j>i;i++)g.inputs[i]&&null!=g.inputs[i].link&&(h+=1);0==h?b.push(g):e[g.id]=h}for(;;){if(0==b.length)break;var g=b.shift();if(a.push(g),delete c[g.id],g.outputs)for(var f=0;f<g.outputs.length;f++){var k=g.outputs[f];if(null!=k&&null!=k.links&&0!=k.links.length)for(var i=0;i<k.links.length;i++){var l=k.links[i],m=this.links[l];if(m&&!d[m.id]){var n=this.getNodeById(m.target_id);null!=n?(d[m.id]=!0,e[n.id]-=1,0==e[n.id]&&b.push(n)):d[m.id]=!0}}}}for(var f in c)a.push(c[f]);a.length!=this._nodes.length&&LiteGraph.debug&&console.log("something went wrong, nodes missing");for(var f in a)a[f].order=f;return a},LGraph.prototype.getTime=function(){return this.globaltime},LGraph.prototype.getFixedTime=function(){return this.fixedtime},LGraph.prototype.getElapsedTime=function(){return this.elapsed_time},LGraph.prototype.sendEventToAllNodes=function(a,b){var c=this._nodes_in_order?this._nodes_in_order:this._nodes;for(var d in c)c[d][a]&&c[d][a](b)},LGraph.prototype.sendActionToCanvas=function(a,b){if(this.list_of_graphcanvas)for(var c in this.list_of_graphcanvas){var d=this.list_of_graphcanvas[c];d[a]&&d[a].apply(d,b)}},LGraph.prototype.add=function(a,b){if(a&&(-1==a.id||null==this._nodes_by_id[a.id])){if(this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return(null==a.id||-1==a.id)&&(a.id=this.last_node_id++),a.graph=this,this._nodes.push(a),this._nodes_by_id[a.id]=a,a.onAdded&&a.onAdded(),this.config.align_to_grid&&a.alignToGrid(),b||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(a),this.setDirtyCanvas(!0),this.change(),a}},LGraph.prototype.remove=function(a){if(null!=this._nodes_by_id[a.id]&&!a.ignore_remove){if(a.inputs)for(var b=0;b<a.inputs.length;b++){var c=a.inputs[b];null!=c.link&&a.disconnectInput(b)}if(a.outputs)for(var b=0;b<a.outputs.length;b++){var c=a.outputs[b];null!=c.links&&c.links.length&&a.disconnectOutput(b)}a.id=-1,a.onRemoved&&a.onRemoved(),a.graph=null;for(var b in this.list_of_graphcanvas){var d=this.list_of_graphcanvas[b];d.selected_nodes[a.id]&&delete d.selected_nodes[a.id],d.node_dragged==a&&(d.node_dragged=null)}var e=this._nodes.indexOf(a);-1!=e&&this._nodes.splice(e,1),delete this._nodes_by_id[a.id],this.onNodeRemoved&&this.onNodeRemoved(a),this.setDirtyCanvas(!0,!0),this.change(),this.updateExecutionOrder()}},LGraph.prototype.getNodeById=function(a){return null==a?null:this._nodes_by_id[a]},LGraph.prototype.findNodesByType=function(a){var b=[];for(var c in this._nodes)this._nodes[c].type==a&&b.push(this._nodes[c]);return b},LGraph.prototype.findNodesByTitle=function(a){var b=[];for(var c in this._nodes)this._nodes[c].title==a&&b.push(this._nodes[c]);return b},LGraph.prototype.getNodeOnPos=function(a,b,c){c=c||this._nodes;for(var d=c.length-1;d>=0;d--){var e=c[d];if(e.isPointInsideNode(a,b))return e}return null},LGraph.prototype.addGlobalInput=function(a,b,c){this.global_inputs[a]={name:a,type:b,value:c},this.onGlobalInputAdded&&this.onGlobalInputAdded(a,b),this.onGlobalsChange&&this.onGlobalsChange()},LGraph.prototype.setGlobalInputData=function(a,b){var c=this.global_inputs[a];c&&(c.value=b)},LGraph.prototype.getGlobalInputData=function(a){var b=this.global_inputs[a];return b?b.value:null},LGraph.prototype.renameGlobalInput=function(a,b){if(b!=a){if(!this.global_inputs[a])return!1;if(this.global_inputs[b])return console.error("there is already one input with that name"),!1;this.global_inputs[b]=this.global_inputs[a],delete this.global_inputs[a],this.onGlobalInputRenamed&&this.onGlobalInputRenamed(a,b),this.onGlobalsChange&&this.onGlobalsChange()}},LGraph.prototype.changeGlobalInputType=function(a,b){return this.global_inputs[a]?void(this.global_inputs[a].type!=b&&(this.global_inputs[a].type=b,this.onGlobalInputTypeChanged&&this.onGlobalInputTypeChanged(a,b))):!1},LGraph.prototype.removeGlobalInput=function(a){return this.global_inputs[a]?(delete this.global_inputs[a],this.onGlobalInputRemoved&&this.onGlobalInputRemoved(a),this.onGlobalsChange&&this.onGlobalsChange(),!0):!1},LGraph.prototype.addGlobalOutput=function(a,b,c){this.global_outputs[a]={name:a,type:b,value:c},this.onGlobalOutputAdded&&this.onGlobalOutputAdded(a,b),this.onGlobalsChange&&this.onGlobalsChange()},LGraph.prototype.setGlobalOutputData=function(a,b){var c=this.global_outputs[a];c&&(c.value=b)},LGraph.prototype.getGlobalOutputData=function(a){var b=this.global_outputs[a];return b?b.value:null},LGraph.prototype.renameGlobalOutput=function(a,b){return this.global_outputs[a]?this.global_outputs[b]?(console.error("there is already one output with that name"),!1):(this.global_outputs[b]=this.global_outputs[a],delete this.global_outputs[a],this.onGlobalOutputRenamed&&this.onGlobalOutputRenamed(a,b),void(this.onGlobalsChange&&this.onGlobalsChange())):!1},LGraph.prototype.changeGlobalOutputType=function(a,b){return this.global_outputs[a]?void(this.global_outputs[a].type!=b&&(this.global_outputs[a].type=b,this.onGlobalOutputTypeChanged&&this.onGlobalOutputTypeChanged(a,b))):!1},LGraph.prototype.removeGlobalOutput=function(a){return this.global_outputs[a]?(delete this.global_outputs[a],this.onGlobalOutputRemoved&&this.onGlobalOutputRemoved(a),this.onGlobalsChange&&this.onGlobalsChange(),!0):!1},LGraph.prototype.setInputData=function(a,b){var c=this.findNodesByName(a);for(var d in c)c[d].setValue(b)},LGraph.prototype.getOutputData=function(a){var b=this.findNodesByName(a);return b.length?m[0].getValue():null},LGraph.prototype.triggerInput=function(a,b){var c=this.findNodesByName(a);for(var d in c)c[d].onTrigger(b)},LGraph.prototype.setCallback=function(a,b){var c=this.findNodesByName(a);for(var d in c)c[d].setTrigger(b)},LGraph.prototype.onConnectionChange=function(){this.updateExecutionOrder()},LGraph.prototype.isLive=function(){for(var a in this.list_of_graphcanvas){var b=this.list_of_graphcanvas[a];if(b.live_mode)return!0}return!1},LGraph.prototype.change=function(){LiteGraph.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},LGraph.prototype.setDirtyCanvas=function(a,b){this.sendActionToCanvas("setDirty",[a,b])},LGraph.prototype.serialize=function(){var a=[];for(var b in this._nodes)a.push(this._nodes[b].serialize());for(var b in this.links)this.links[b].data=null;var c={iteration:this.iteration,frame:this.frame,last_node_id:this.last_node_id,last_link_id:this.last_link_id,links:LiteGraph.cloneObject(this.links),config:this.config,nodes:a};return c},LGraph.prototype.configure=function(a,b){b||this.clear();var c=a.nodes;for(var d in a)this[d]=a[d];var e=!1;this._nodes=[];for(var d in c){var f=c[d],g=LiteGraph.createNode(f.type,f.title);g?(g.id=f.id,this.add(g,!0),g.configure(f)):(LiteGraph.debug&&console.log("Node not found: "+f.type),e=!0)}return this.updateExecutionOrder(),this.setDirtyCanvas(!0,!0),e},LGraph.prototype.onNodeTrace=function(){},LGraphCanvas.link_type_colors={number:"#AAC",node:"#DCA"},LGraphCanvas.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.scale=1,this.offset=[0,0],this.selected_nodes={},this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highquality_render=!0,this.editor_alpha=1,this.pause_rendering=!1,this.render_shadows=!0,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.node_in_panel=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.title_text_font="bold 14px Arial",this.inner_text_font="normal 12px Arial",this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!0,this.render_connection_arrows=!0,this.connections_width=4,this.onClear&&this.onClear()},LGraphCanvas.prototype.setGraph=function(a){if(this.graph!=a){if(this.clear(),!a&&this.graph)return void this.graph.detachCanvas(this);a.attachCanvas(this),this.setDirty(!0,!0)}},LGraphCanvas.prototype.openSubgraph=function(a){if(!a)throw"graph cannot be null";if(this.graph==a)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),a.attachCanvas(this),this.setDirty(!0,!0)},LGraphCanvas.prototype.closeSubgraph=function(){if(this._graph_stack&&0!=this._graph_stack.length){var a=this._graph_stack.pop();a.attachCanvas(this),this.setDirty(!0,!0)}},LGraphCanvas.prototype.setCanvas=function(a){var b=this;if("string"==typeof a&&(a=document.getElementById(a)),null==a)throw"Error creating LiteGraph canvas: Canvas not found";if(a!=this.canvas){if(this.canvas=a,a.className+=" lgraphcanvas",a.data=this,this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==a.getContext)throw"This browser doesnt support Canvas";var c=this.ctx=a.getContext("2d");null==c&&(console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),a.addEventListener("mousedown",this.processMouseDown.bind(this),!0),a.addEventListener("mousemove",this._mousemove_callback),a.addEventListener("contextmenu",function(a){return a.preventDefault(),!1}),a.addEventListener("mousewheel",this.processMouseWheel.bind(this),!1),a.addEventListener("DOMMouseScroll",this.processMouseWheel.bind(this),!1),a.addEventListener("touchstart",this.touchHandler.bind(this),!0),a.addEventListener("touchmove",this.touchHandler.bind(this),!0),a.addEventListener("touchend",this.touchHandler.bind(this),!0),a.addEventListener("touchcancel",this.touchHandler.bind(this),!0),a.addEventListener("keydown",function(a){b.processKeyDown(a)}),a.addEventListener("keyup",function(a){b.processKeyUp(a)}),a.ondragover=function(){return!1},a.ondragend=function(){return console.log("out"),!1},a.ondrop=function(a){a.preventDefault(),b.adjustMouseEvent(a);var c=[a.canvasX,a.canvasY],d=b.graph.getNodeOnPos(c[0],c[1]);if(d&&d.onDropFile){var e=a.dataTransfer.files[0],f=e.name,g=(LGraphCanvas.getFileExtension(f),new FileReader);g.onload=function(a){var b=a.target.result;d.onDropFile(b,f,e)};var h=e.type.split("/")[0];return"text"==h?g.readAsText(e):"image"==h?g.readAsDataURL(e):g.readAsArrayBuffer(e),!1}}}},LGraphCanvas.getFileExtension=function(a){var b=a.indexOf("?");-1!=b&&(a=a.substr(0,b));var c=a.lastIndexOf(".");return-1==c?"":a.substr(c+1).toLowerCase()},LGraphCanvas.prototype.enableWebGL=function(){if(void 0===typeof GL)throw"litegl.js must be included to use a WebGL canvas";if(void 0===typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl},LGraphCanvas.prototype.setDirty=function(a,b){a&&(this.dirty_canvas=!0),b&&(this.dirty_bgcanvas=!0)},LGraphCanvas.prototype.getCanvasWindow=function(){var a=this.canvas.ownerDocument;return a.defaultView||a.parentWindow},LGraphCanvas.prototype.startRendering=function(){function a(){this.pause_rendering||this.draw();var b=this.getCanvasWindow();this.is_rendering&&b.requestAnimationFrame(a.bind(this))}this.is_rendering||(this.is_rendering=!0,a.call(this))},LGraphCanvas.prototype.stopRendering=function(){this.is_rendering=!1},LGraphCanvas.prototype.processMouseDown=function(a){if(this.graph){this.adjustMouseEvent(a);{var b=this.getCanvasWindow();b.document}this.canvas.removeEventListener("mousemove",this._mousemove_callback),b.document.addEventListener("mousemove",this._mousemove_callback,!0),b.document.addEventListener("mouseup",this._mouseup_callback,!0);var c=this.graph.getNodeOnPos(a.canvasX,a.canvasY,this.visible_nodes);if(1==a.which){if(!a.shiftKey){var d=[];for(var e in this.selected_nodes)this.selected_nodes[e]!=c&&d.push(this.selected_nodes[e]);for(var e in d)this.processNodeDeselected(d[e])}var f=!1;if(c){this.live_mode||c.flags.pinned||this.bringToFront(c);var g=!1;if(!this.connecting_node&&!c.flags.collapsed&&!this.live_mode){if(c.outputs)for(var e=0,h=c.outputs.length;h>e;++e){var i=c.outputs[e],j=c.getConnectionPos(!1,e);if(isInsideRectangle(a.canvasX,a.canvasY,j[0]-10,j[1]-5,20,10)){this.connecting_node=c,this.connecting_output=i,this.connecting_pos=c.getConnectionPos(!1,e),this.connecting_slot=e,g=!0;break}}if(c.inputs)for(var e=0,h=c.inputs.length;h>e;++e){var k=c.inputs[e],j=c.getConnectionPos(!0,e);isInsideRectangle(a.canvasX,a.canvasY,j[0]-10,j[1]-5,20,10)&&k.link&&(c.disconnectInput(e),this.dirty_bgcanvas=!0,g=!0)}!g&&isInsideRectangle(a.canvasX,a.canvasY,c.pos[0]+c.size[0]-5,c.pos[1]+c.size[1]-5,5,5)&&(this.resizing_node=c,this.canvas.style.cursor="se-resize",g=!0)}if(!g&&isInsideRectangle(a.canvasX,a.canvasY,c.pos[0],c.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&(c.collapse(),g=!0),!g){var l=!1,m=LiteGraph.getTime();m-this.last_mouseclick<300&&this.selected_nodes[c.id]&&(c.onDblClick&&c.onDblClick(a),this.processNodeDblClicked(c),l=!0),c.onMouseDown&&c.onMouseDown(a)?l=!0:this.live_mode&&(f=!0,l=!0),l||(this.allow_dragnodes&&(this.node_dragged=c),this.selected_nodes[c.id]||this.processNodeSelected(c,a)),this.dirty_canvas=!0}}else f=!0;f&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else 2==a.which||3==a.which&&this.processContextualMenu(c,a);return this.last_mouse[0]=a.localX,this.last_mouse[1]=a.localY,this.last_mouseclick=LiteGraph.getTime(),this.canvas_mouse=[a.canvasX,a.canvasY],this.graph.change(),(!b.document.activeElement||"input"!=b.document.activeElement.nodeName.toLowerCase()&&"textarea"!=b.document.activeElement.nodeName.toLowerCase())&&a.preventDefault(),a.stopPropagation(),!1}},LGraphCanvas.prototype.processMouseMove=function(a){if(this.graph){this.adjustMouseEvent(a);var b=[a.localX,a.localY],c=[b[0]-this.last_mouse[0],b[1]-this.last_mouse[1]];if(this.last_mouse=b,this.canvas_mouse=[a.canvasX,a.canvasY],this.dragging_canvas)this.offset[0]+=c[0]/this.scale,this.offset[1]+=c[1]/this.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else{this.connecting_node&&(this.dirty_canvas=!0);var d=this.graph.getNodeOnPos(a.canvasX,a.canvasY,this.visible_nodes);for(var e in this.graph._nodes)this.graph._nodes[e].mouseOver&&d!=this.graph._nodes[e]&&(this.graph._nodes[e].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(a),this.node_over=null,this.dirty_canvas=!0);if(d){if(d.mouseOver||(d.mouseOver=!0,this.node_over=d,this.dirty_canvas=!0,d.onMouseEnter&&d.onMouseEnter(a)),d.onMouseMove&&d.onMouseMove(a),this.connecting_node){var f=this._highlight_input||[0,0],g=this.isOverNodeInput(d,a.canvasX,a.canvasY,f);if(-1!=g&&d.inputs[g]){var h=d.inputs[g].type;h!=this.connecting_output.type&&h&&this.connecting_output.type||(this._highlight_input=f)}else this._highlight_input=null}this.canvas.style.cursor=isInsideRectangle(a.canvasX,a.canvasY,d.pos[0]+d.size[0]-5,d.pos[1]+d.size[1]-5,5,5)?"se-resize":null}else this.canvas.style.cursor=null;if(this.node_capturing_input&&this.node_capturing_input!=d&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(a),this.node_dragged&&!this.live_mode){for(var e in this.selected_nodes){var d=this.selected_nodes[e];d.pos[0]+=c[0]/this.scale,d.pos[1]+=c[1]/this.scale}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){this.resizing_node.size[0]+=c[0]/this.scale,this.resizing_node.size[1]+=c[1]/this.scale;var i=Math.max(this.resizing_node.inputs?this.resizing_node.inputs.length:0,this.resizing_node.outputs?this.resizing_node.outputs.length:0);this.resizing_node.size[1]<i*LiteGraph.NODE_SLOT_HEIGHT+4&&(this.resizing_node.size[1]=i*LiteGraph.NODE_SLOT_HEIGHT+4),this.resizing_node.size[0]<this.resizing_node.title_width&&(this.resizing_node.size[0]=this.resizing_node.title_width),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return a.preventDefault(),!1}},LGraphCanvas.prototype.processMouseUp=function(a){if(this.graph){var b=this.getCanvasWindow(),c=b.document;if(c.removeEventListener("mousemove",this._mousemove_callback,!0),this.canvas.addEventListener("mousemove",this._mousemove_callback,!0),c.removeEventListener("mouseup",this._mouseup_callback,!0),this.adjustMouseEvent(a),1==a.which)if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var d=this.graph.getNodeOnPos(a.canvasX,a.canvasY,this.visible_nodes);if(d)if("node"==this.connecting_output.type)this.connecting_node.connect(this.connecting_slot,d,-1);else{var e=this.isOverNodeInput(d,a.canvasX,a.canvasY);if(-1!=e)this.connecting_node.connect(this.connecting_slot,d,e);else{var f=d.getInputInfo(0);f&&!f.link&&f.type==this.connecting_output.type&&this.connecting_node.connect(this.connecting_slot,d,0)}}this.connecting_output=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else this.resizing_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.resizing_node=null):this.node_dragged?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),this.graph.config.align_to_grid&&this.node_dragged.alignToGrid(),this.node_dragged=null):(this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(a),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(a));else 2==a.which?(this.dirty_canvas=!0,this.dragging_canvas=!1):3==a.which&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return this.graph.change(),a.stopPropagation(),a.preventDefault(),!1}},LGraphCanvas.prototype.isOverNodeInput=function(a,b,c,d){if(a.inputs)for(var e=0,f=a.inputs.length;f>e;++e){var g=(a.inputs[e],a.getConnectionPos(!0,e));if(isInsideRectangle(b,c,g[0]-10,g[1]-5,20,10))return d&&(d[0]=g[0],d[1]=g[1]),e}return-1},LGraphCanvas.prototype.processKeyDown=function(a){if(this.graph){var b=!1;if(65==a.keyCode&&a.ctrlKey&&(this.selectAllNodes(),b=!0),(46==a.keyCode||8==a.keyCode)&&this.deleteSelectedNodes(),this.selected_nodes)for(var c in this.selected_nodes)this.selected_nodes[c].onKeyDown&&this.selected_nodes[c].onKeyDown(a);return this.graph.change(),b?(a.preventDefault(),!1):void 0}},LGraphCanvas.prototype.processKeyUp=function(a){if(this.graph){if(this.selected_nodes)for(var b in this.selected_nodes)this.selected_nodes[b].onKeyUp&&this.selected_nodes[b].onKeyUp(a);this.graph.change()}},LGraphCanvas.prototype.processMouseWheel=function(a){if(this.graph&&this.allow_dragcanvas){var b=null!=a.wheelDeltaY?a.wheelDeltaY:-60*a.detail;this.adjustMouseEvent(a);var c=this.scale;return b>0?c*=1.1:0>b&&(c*=1/1.1),this.setZoom(c,[a.localX,a.localY]),this.graph.change(),a.preventDefault(),!1}},LGraphCanvas.prototype.onNodeSelected=function(){},LGraphCanvas.prototype.processNodeSelected=function(a,b){LiteGraph.dispatchEvent("hola",this),a.selected=!0,a.onSelected&&a.onSelected(),b&&b.shiftKey?this.selected_nodes[a.id]=a:(this.selected_nodes={},this.selected_nodes[a.id]=a),this.dirty_canvas=!0,this.onNodeSelected&&this.onNodeSelected(a)},LGraphCanvas.prototype.processNodeDeselected=function(a){a.selected=!1,a.onDeselected&&a.onDeselected(),delete this.selected_nodes[a.id],this.onNodeDeselected&&this.onNodeDeselected(),this.dirty_canvas=!0},LGraphCanvas.prototype.processNodeDblClicked=function(a){this.onShowNodePanel&&this.onShowNodePanel(a),this.onNodeDblClicked&&this.onNodeDblClicked(a),this.setDirty(!0)},LGraphCanvas.prototype.selectNode=function(a){this.deselectAllNodes(),a&&(!a.selected&&a.onSelected&&a.onSelected(),a.selected=!0,this.selected_nodes[a.id]=a,this.setDirty(!0))},LGraphCanvas.prototype.selectAllNodes=function(){for(var a in this.graph._nodes){var b=this.graph._nodes[a];!b.selected&&b.onSelected&&b.onSelected(),b.selected=!0,this.selected_nodes[this.graph._nodes[a].id]=b}this.setDirty(!0)},LGraphCanvas.prototype.deselectAllNodes=function(){for(var a in this.selected_nodes){var b=this.selected_nodes;b.onDeselected&&b.onDeselected(),b.selected=!1}this.selected_nodes={},this.setDirty(!0)},LGraphCanvas.prototype.deleteSelectedNodes=function(){for(var a in this.selected_nodes){var b=this.selected_nodes[a];this.graph.remove(b)}this.selected_nodes={},this.setDirty(!0)},LGraphCanvas.prototype.centerOnNode=function(a){this.offset[0]=-a.pos[0]-.5*a.size[0]+.5*this.canvas.width/this.scale,this.offset[1]=-a.pos[1]-.5*a.size[1]+.5*this.canvas.height/this.scale,this.setDirty(!0,!0)},LGraphCanvas.prototype.adjustMouseEvent=function(a){var b=this.canvas.getBoundingClientRect();a.localX=a.pageX-b.left,a.localY=a.pageY-b.top,a.canvasX=a.localX/this.scale-this.offset[0],a.canvasY=a.localY/this.scale-this.offset[1]},LGraphCanvas.prototype.setZoom=function(a,b){b||(b=[.5*this.canvas.width,.5*this.canvas.height]);var c=this.convertOffsetToCanvas(b);this.scale=a,this.scale>this.max_zoom?this.scale=this.max_zoom:this.scale<this.min_zoom&&(this.scale=this.min_zoom);var d=this.convertOffsetToCanvas(b),e=[d[0]-c[0],d[1]-c[1]];this.offset[0]+=e[0],this.offset[1]+=e[1],this.dirty_canvas=!0,this.dirty_bgcanvas=!0},LGraphCanvas.prototype.convertOffsetToCanvas=function(a){return[a[0]/this.scale-this.offset[0],a[1]/this.scale-this.offset[1]]},LGraphCanvas.prototype.convertCanvasToOffset=function(a){return[(a[0]+this.offset[0])*this.scale,(a[1]+this.offset[1])*this.scale]},LGraphCanvas.prototype.convertEventToCanvas=function(a){var b=this.canvas.getClientRects()[0];return this.convertOffsetToCanvas([a.pageX-b.left,a.pageY-b.top])},LGraphCanvas.prototype.bringToFront=function(a){var b=this.graph._nodes.indexOf(a);-1!=b&&(this.graph._nodes.splice(b,1),this.graph._nodes.push(a))},LGraphCanvas.prototype.sendToBack=function(a){var b=this.graph._nodes.indexOf(a);-1!=b&&(this.graph._nodes.splice(b,1),this.graph._nodes.unshift(a))},LGraphCanvas.prototype.computeVisibleNodes=function(){var a=[];for(var b in this.graph._nodes){var c=this.graph._nodes[b];(!this.live_mode||c.onDrawBackground||c.onDrawForeground)&&overlapBounding(this.visible_area,c.getBounding())&&a.push(c)}return a},LGraphCanvas.prototype.draw=function(a,b){var c=LiteGraph.getTime();if(this.render_time=.001*(c-this.last_draw_time),this.last_draw_time=c,this.graph){var d=[-this.offset[0],-this.offset[1]],e=[d[0]+this.canvas.width/this.scale,d[1]+this.canvas.height/this.scale];this.visible_area=new Float32Array([d[0],d[1],e[0],e[1]])}(this.dirty_bgcanvas||b)&&this.drawBackCanvas(),(this.dirty_canvas||a)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1},LGraphCanvas.prototype.drawFrontCanvas=function(){this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var a=this.ctx;if(a){a.start&&a.start();var b=this.canvas;if(a.restore(),a.setTransform(1,0,0,1,0,0),this.dirty_area&&(a.save(),a.beginPath(),a.rect(this.dirty_area[0],this.dirty_area[1],this.dirty_area[2],this.dirty_area[3]),a.clip()),a.clearRect(0,0,b.width,b.height),this.bgcanvas==this.canvas?this.drawBackCanvas():a.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(b,a),this.show_info&&(a.font="10px Arial",a.fillStyle="#888",this.graph?(a.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),a.fillText("I: "+this.graph.iteration,5,26),a.fillText("F: "+this.frame,5,39),a.fillText("FPS:"+this.fps.toFixed(2),5,52)):a.fillText("No graph selected",5,13)),this.graph){a.save(),a.scale(this.scale,this.scale),a.translate(this.offset[0],this.offset[1]);var c=0,d=this.computeVisibleNodes();this.visible_nodes=d;for(var e in d){var f=d[e];a.save(),a.translate(f.pos[0],f.pos[1]),this.drawNode(f,a),c+=1,a.restore()}if(this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(a)),null!=this.connecting_pos){a.lineWidth=this.connections_width;var g="node"==this.connecting_output.type?"#F85":"#AFA";this.renderLink(a,this.connecting_pos,[this.canvas_mouse[0],this.canvas_mouse[1]],g),a.beginPath(),a.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),a.fill(),a.fillStyle="#ffcc00",this._highlight_input&&(a.beginPath(),a.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),a.fill())}a.restore()}this.dirty_area&&a.restore(),a.finish&&a.finish(),this.dirty_canvas=!1}},LGraphCanvas.prototype.drawBackCanvas=function(){var a=this.bgcanvas;this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var b=this.bgctx;if(b.start&&b.start(),b.clearRect(0,0,a.width,a.height),b.restore(),b.setTransform(1,0,0,1,0,0),this.graph){if(b.save(),b.scale(this.scale,this.scale),b.translate(this.offset[0],this.offset[1]),this.background_image&&this.scale>.5){if(b.globalAlpha=(1-.5/this.scale)*this.editor_alpha,b.webkitImageSmoothingEnabled=b.mozImageSmoothingEnabled=b.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var c=this;this._bg_img.onload=function(){c.draw(!0,!0)}}var d=null;this._bg_img!=this._pattern_img&&this._bg_img.width>0?(d=b.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=d):d=this._pattern,d&&(b.fillStyle=d,b.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2]-this.visible_area[0],this.visible_area[3]-this.visible_area[1]),b.fillStyle="transparent"),b.globalAlpha=1,b.webkitImageSmoothingEnabled=b.mozImageSmoothingEnabled=b.imageSmoothingEnabled=!0}this.onBackgroundRender&&this.onBackgroundRender(a,b),b.strokeStyle="#235",b.strokeRect(0,0,a.width,a.height),this.render_connections_shadows?(b.shadowColor="#000",b.shadowOffsetX=0,b.shadowOffsetY=0,b.shadowBlur=6):b.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(b),b.shadowColor="rgba(0,0,0,0)",b.restore()}b.finish&&b.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0},LGraphCanvas.prototype.drawNode=function(a,b){var c=!1,d=a.color||LiteGraph.NODE_DEFAULT_COLOR,e=a.getTitleWidth()||a.computeTitleWidth(b,this.title_text_font),f=!0;if((a.flags.skip_title_render||a.graph.isLive())&&(f=!1),a.mouseOver&&(f=!0),a.mouseOver&&(c=!0),a.selected||(this.render_shadows?(b.shadowColor="rgba(0,0,0,0.5)",b.shadowOffsetX=2,b.shadowOffsetY=2,b.shadowBlur=3):b.shadowColor="transparent"),this.live_mode)return void(a.flags.collapsed||(b.shadowColor="transparent",a.onDrawForeground&&a.onDrawForeground(b)));var g=this.editor_alpha;b.globalAlpha=g;var h=a.shape||LiteGraph.NODE_DEFAULT_SHAPE,i=new Float32Array(a.size);a.flags.collapsed&&(i[0]=e,i[1]=0),a.flags.clip_area&&(b.save(),"box"==h?(b.beginPath(),b.rect(0,0,i[0],i[1])):"round"==h?b.roundRect(0,0,i[0],i[1],10):"circle"==h&&(b.beginPath(),b.arc(.5*i[0],.5*i[1],.5*i[0],0,2*Math.PI)),b.clip()),this.drawNodeShape(a,b,i,d,a.bgcolor,!f,a.selected),b.shadowColor="transparent",b.textAlign="left",b.font=this.inner_text_font;var j=this.scale>.6;if(!a.flags.collapsed){if(a.inputs)for(var k=0;k<a.inputs.length;k++){var l=a.inputs[k];b.globalAlpha=g,null==this.connecting_node||0==this.connecting_output.type||0==a.inputs[k].type||this.connecting_output.type==a.inputs[k].type||LiteGraph.compareNodeTypes(this.connecting_output,a.inputs[k])||(b.globalAlpha=.4*g),b.fillStyle=null!=l.link?"#7F7":"#AAA";var m=a.getConnectionPos(!0,k);if(m[0]-=a.pos[0],m[1]-=a.pos[1],b.beginPath(),b.arc(m[0],m[1],4,0,2*Math.PI),b.fill(),j){var n=null!=l.label?l.label:l.name;n&&(b.fillStyle=d,b.fillText(n,m[0]+10,m[1]+5))}}if(this.connecting_node&&(b.globalAlpha=.4*g),b.lineWidth=1,b.textAlign="right",b.strokeStyle="black",a.outputs)for(var k=0;k<a.outputs.length;k++){var l=a.outputs[k],m=a.getConnectionPos(!1,k);if(m[0]-=a.pos[0],m[1]-=a.pos[1],b.fillStyle=l.links&&l.links.length?"#7F7":"#AAA",b.beginPath(),b.arc(m[0],m[1],4,0,2*Math.PI),b.fill(),b.stroke(),j){var n=null!=l.label?l.label:l.name;n&&(b.fillStyle=d,b.fillText(n,m[0]-10,m[1]+5))
}}b.textAlign="left",b.globalAlpha=1,a.onDrawForeground&&a.onDrawForeground(b)}a.flags.clip_area&&b.restore(),b.globalAlpha=1},LGraphCanvas.prototype.drawNodeShape=function(a,b,c,d,e,f,g){b.strokeStyle=d||LiteGraph.NODE_DEFAULT_COLOR,b.fillStyle=e||LiteGraph.NODE_DEFAULT_BGCOLOR;var h=LiteGraph.NODE_TITLE_HEIGHT,i=a.shape||LiteGraph.NODE_DEFAULT_SHAPE;if("box"==i)b.beginPath(),b.rect(0,f?0:-h,c[0]+1,f?c[1]:c[1]+h),b.fill(),b.shadowColor="transparent",g&&(b.strokeStyle=LiteGraph.NODE_SELECTED_COLOR,b.strokeRect(-.5,f?-.5:-h+-.5,c[0]+2,f?c[1]+2:c[1]+h+2-1),b.strokeStyle=d);else if("round"==i){var j=b.roundRect(0,f?0:-h,c[0],f?c[1]:c[1]+h,10);b.fill(),g&&(b.strokeStyle=LiteGraph.NODE_SELECTED_COLOR,j.stroke(),b.strokeStyle=d)}else"circle"==i&&(b.beginPath(),b.arc(.5*c[0],.5*c[1],.5*c[0],0,2*Math.PI),b.fill());if(b.shadowColor="transparent",a.bgImage&&a.bgImage.width&&b.drawImage(a.bgImage,.5*(c[0]-a.bgImage.width),.5*(c[1]-a.bgImage.height)),a.bgImageUrl&&!a.bgImage&&(a.bgImage=a.loadImage(a.bgImageUrl)),a.onDrawBackground&&a.onDrawBackground(b),!f){b.fillStyle=d||LiteGraph.NODE_DEFAULT_COLOR;var k=b.globalAlpha;b.globalAlpha=.5*k,"box"==i?(b.beginPath(),b.rect(0,-h,c[0]+1,h),b.fill()):"round"==i&&(a.flags.collapsed?b.roundRect(0,-h,c[0],h,LiteGraph.NODE_COLLAPSED_RADIUS,LiteGraph.NODE_COLLAPSED_RADIUS):b.roundRect(0,-h,c[0],h,10,0),b.fill()),b.fillStyle=a.boxcolor||LiteGraph.NODE_DEFAULT_BOXCOLOR,b.beginPath(),"round"==i?b.arc(.5*h,h*-.5,.5*(h-6),0,2*Math.PI):b.rect(3,-h+3,h-6,h-6),b.fill(),b.globalAlpha=k,b.font=this.title_text_font;var l=a.getTitle();l&&this.scale>.5&&(b.fillStyle=LiteGraph.NODE_TITLE_COLOR,b.fillText(l,16,13-h))}},LGraphCanvas.prototype.drawNodeCollapsed=function(a,b,c,d){b.strokeStyle=c||LiteGraph.NODE_DEFAULT_COLOR,b.fillStyle=d||LiteGraph.NODE_DEFAULT_BGCOLOR;var e=LiteGraph.NODE_COLLAPSED_RADIUS,f=a.shape||LiteGraph.NODE_DEFAULT_SHAPE;"circle"==f?(b.beginPath(),b.arc(.5*a.size[0],.5*a.size[1],e,0,2*Math.PI),b.fill(),b.shadowColor="rgba(0,0,0,0)",b.stroke(),b.fillStyle=a.boxcolor||LiteGraph.NODE_DEFAULT_BOXCOLOR,b.beginPath(),b.arc(.5*a.size[0],.5*a.size[1],.5*e,0,2*Math.PI),b.fill()):"round"==f?(b.beginPath(),b.roundRect(.5*a.size[0]-e,.5*a.size[1]-e,2*e,2*e,5),b.fill(),b.shadowColor="rgba(0,0,0,0)",b.stroke(),b.fillStyle=a.boxcolor||LiteGraph.NODE_DEFAULT_BOXCOLOR,b.beginPath(),b.roundRect(.5*a.size[0]-.5*e,.5*a.size[1]-.5*e,e,e,2),b.fill()):(b.beginPath(),b.rect(0,0,a.size[0],2*e),b.fill(),b.shadowColor="rgba(0,0,0,0)",b.stroke(),b.fillStyle=a.boxcolor||LiteGraph.NODE_DEFAULT_BOXCOLOR,b.beginPath(),b.rect(.5*e,.5*e,e,e),b.fill())},LGraphCanvas.link_colors=["#AAC","#ACA","#CAA"],LGraphCanvas.prototype.drawConnections=function(a){a.lineWidth=this.connections_width,a.fillStyle="#AAA",a.strokeStyle="#AAA",a.globalAlpha=this.editor_alpha;for(var b in this.graph._nodes){var c=this.graph._nodes[b];if(c.inputs&&c.inputs.length)for(var d in c.inputs){var e=c.inputs[d];if(e&&null!=e.link){var f=e.link,g=this.graph.links[f];if(g){var h=this.graph.getNodeById(g.origin_id);if(null!=h){var i=g.origin_slot,j=null;j=-1==i?[h.pos[0]+10,h.pos[1]+10]:h.getConnectionPos(!1,i);var k=LGraphCanvas.link_type_colors[c.inputs[d].type];null==k&&(k=LGraphCanvas.link_colors[c.id%LGraphCanvas.link_colors.length]),this.renderLink(a,j,c.getConnectionPos(!0,d),k)}}}}}a.globalAlpha=1},LGraphCanvas.prototype.renderLink=function(a,b,c,d){if(!this.highquality_render)return a.beginPath(),a.moveTo(b[0],b[1]),a.lineTo(c[0],c[1]),void a.stroke();var e=distance(b,c);if(this.render_connections_border&&this.scale>.6&&(a.lineWidth=this.connections_width+4),a.beginPath(),this.render_curved_connections?(a.moveTo(b[0],b[1]),a.bezierCurveTo(b[0]+.25*e,b[1],c[0]-.25*e,c[1],c[0],c[1])):(a.moveTo(b[0]+10,b[1]),a.lineTo(.5*(b[0]+10+(c[0]-10)),b[1]),a.lineTo(.5*(b[0]+10+(c[0]-10)),c[1]),a.lineTo(c[0]-10,c[1])),this.render_connections_border&&this.scale>.6&&(a.strokeStyle="rgba(0,0,0,0.5)",a.stroke()),a.lineWidth=this.connections_width,a.fillStyle=a.strokeStyle=d,a.stroke(),this.render_connection_arrows&&this.scale>.6){var f=this.computeConnectionPoint(b,c,.5),g=this.computeConnectionPoint(b,c,.51),h=0;h=this.render_curved_connections?-Math.atan2(g[0]-f[0],g[1]-f[1]):c[1]>b[1]?0:Math.PI,a.save(),a.translate(f[0],f[1]),a.rotate(h),a.beginPath(),a.moveTo(-5,-5),a.lineTo(0,5),a.lineTo(5,-5),a.fill(),a.restore()}},LGraphCanvas.prototype.computeConnectionPoint=function(a,b,c){var d=distance(a,b),e=a,f=[a[0]+.25*d,a[1]],g=[b[0]-.25*d,b[1]],h=b,i=(1-c)*(1-c)*(1-c),j=3*(1-c)*(1-c)*c,k=3*(1-c)*c*c,l=c*c*c,m=i*e[0]+j*f[0]+k*g[0]+l*h[0],n=i*e[1]+j*f[1]+k*g[1]+l*h[1];return[m,n]},LGraphCanvas.prototype.resize=function(a,b){if(!a&&!b){var c=this.canvas.parentNode;a=c.offsetWidth,b=c.offsetHeight}(this.canvas.width!=a||this.canvas.height!=b)&&(this.canvas.width=a,this.canvas.height=b,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},LGraphCanvas.prototype.switchLiveMode=function(a){if(!a)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var b=this,c=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var d=setInterval(function(){b.editor_alpha*=c,b.dirty_canvas=!0,b.dirty_bgcanvas=!0,1>c&&b.editor_alpha<.01&&(clearInterval(d),1>c&&(b.live_mode=!0)),c>1&&b.editor_alpha>.99&&(clearInterval(d),b.editor_alpha=1)},1)},LGraphCanvas.prototype.onNodeSelectionChange=function(){},LGraphCanvas.prototype.touchHandler=function(a){var b=a.changedTouches,c=b[0],d="";switch(a.type){case"touchstart":d="mousedown";break;case"touchmove":d="mousemove";break;case"touchend":d="mouseup";break;default:return}var e=this.getCanvasWindow(),f=e.document,g=f.createEvent("MouseEvent");g.initMouseEvent(d,!0,!0,e,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null),c.target.dispatchEvent(g),a.preventDefault()},LGraphCanvas.onMenuAdd=function(a,b,c,d,e){function f(a,b){var c=a.value,d=LiteGraph.getNodeTypesInCategory(c),e=[];for(var f in d)e.push({content:d[f].title,value:d[f].type});return LiteGraph.createContextualMenu(e,{event:b,callback:g,from:l},h),!1}function g(a){var b=LiteGraph.createNode(a.value);b&&(b.pos=d.convertEventToCanvas(e),d.graph.add(b))}var h=d.getCanvasWindow(),i=LiteGraph.getNodeTypesCategories(),j={};for(var k in i)i[k]&&(j[k]={value:i[k],content:i[k],is_menu:!0});var l=LiteGraph.createContextualMenu(j,{event:b,callback:f,from:c},h);return!1},LGraphCanvas.onMenuCollapseAll=function(){},LGraphCanvas.onMenuNodeEdit=function(){},LGraphCanvas.onMenuNodeInputs=function(a,b,c){function d(b){a&&a.addInput(b.value[0],b.value[1],b.value[2])}if(a){var e=a.optional_inputs;if(a.onGetInputs&&(e=a.onGetInputs()),e){var f=[];for(var g in e){var h=e[g],i=h[0];h[2]&&h[2].label&&(i=h[2].label),f.push({content:i,value:h})}{LiteGraph.createContextualMenu(f,{event:b,callback:d,from:c})}}return!1}},LGraphCanvas.onMenuNodeOutputs=function(a,b,c){function d(e){if(a){var f=e.value[1];if(f&&(f.constructor===Object||f.constructor===Array)){var g=[];for(var h in f)g.push({content:h,value:f[h]});return LiteGraph.createContextualMenu(g,{event:b,callback:d,from:c}),!1}a.addOutput(e.value[0],e.value[1])}}if(a){var e=a.optional_outputs;if(a.onGetOutputs&&(e=a.onGetOutputs()),e){var f=[];for(var g in e)-1==a.findOutputSlot(e[g][0])&&f.push({content:e[g][0],value:e[g]});if(f.length){LiteGraph.createContextualMenu(f,{event:b,callback:d,from:c})}}return!1}},LGraphCanvas.onMenuNodeCollapse=function(a){a.flags.collapsed=!a.flags.collapsed,a.setDirtyCanvas(!0,!0)},LGraphCanvas.onMenuNodePin=function(a){a.pin()},LGraphCanvas.onMenuNodeColors=function(a,b,c){function d(b){if(a){var c=LGraphCanvas.node_colors[b.value];c&&(a.color=c.color,a.bgcolor=c.bgcolor,a.setDirtyCanvas(!0))}}var e=[];for(var f in LGraphCanvas.node_colors){var g=LGraphCanvas.node_colors[f],h={value:f,content:"<span style='display: block; color:"+g.color+"; background-color:"+g.bgcolor+"'>"+f+"</span>"};e.push(h)}return LiteGraph.createContextualMenu(e,{event:b,callback:d,from:c}),!1},LGraphCanvas.onMenuNodeShapes=function(a,b){function c(b){a&&(a.shape=b,a.setDirtyCanvas(!0))}return LiteGraph.createContextualMenu(["box","round"],{event:b,callback:c}),!1},LGraphCanvas.onMenuNodeRemove=function(a){0!=a.removable&&(a.graph.remove(a),a.setDirtyCanvas(!0,!0))},LGraphCanvas.onMenuNodeClone=function(a){if(0!=a.clonable){var b=a.clone();b&&(b.pos=[a.pos[0]+5,a.pos[1]+5],a.graph.add(b),a.setDirtyCanvas(!0,!0))}},LGraphCanvas.node_colors={red:{color:"#FAA",bgcolor:"#A44"},green:{color:"#AFA",bgcolor:"#4A4"},blue:{color:"#AAF",bgcolor:"#44A"},white:{color:"#FFF",bgcolor:"#AAA"}},LGraphCanvas.prototype.getCanvasMenuOptions=function(){var a=null;if(this.getMenuOptions?a=this.getMenuOptions():(a=[{content:"Add Node",is_menu:!0,callback:LGraphCanvas.onMenuAdd}],this._graph_stack&&this._graph_stack.length>0&&(a=[{content:"Close subgraph",callback:this.closeSubgraph.bind(this)},null].concat(a))),this.getExtraMenuOptions){var b=this.getExtraMenuOptions(this);b&&(b.push(null),a=b.concat(a))}return a},LGraphCanvas.prototype.getNodeMenuOptions=function(a){var b=null;if(b=a.getMenuOptions?a.getMenuOptions(this):[{content:"Inputs",is_menu:!0,disabled:!0,callback:LGraphCanvas.onMenuNodeInputs},{content:"Outputs",is_menu:!0,disabled:!0,callback:LGraphCanvas.onMenuNodeOutputs},null,{content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",is_menu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",is_menu:!0,callback:LGraphCanvas.onMenuNodeShapes},null],a.getExtraMenuOptions){var c=a.getExtraMenuOptions(this);c&&(c.push(null),b=c.concat(b))}if(a.clonable!==!1&&b.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),a.removable!==!1&&b.push(null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}),a.onGetInputs){var d=a.onGetInputs();d&&d.length&&(b[0].disabled=!1)}if(a.onGetOutputs){var e=a.onGetOutputs();e&&e.length&&(b[1].disabled=!1)}return b},LGraphCanvas.prototype.processContextualMenu=function(a,b){function c(c,e){return c&&c.callback?c.callback(a,e,f,d,b):void 0}var d=this,e=this.getCanvasWindow(),f=LiteGraph.createContextualMenu(a?this.getNodeMenuOptions(a):this.getCanvasMenuOptions(),{event:b,callback:c},e)},LGraphNode.prototype._ctor=function(a){this.title=a||"Unnamed",this.title_width=LiteGraph.NODE_MIN_WIDTH,this.size=[LiteGraph.NODE_WIDTH,60],this.graph=null,this.pos=[10,10],this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.data=null,this.flags={},this.shader_piece=null,this.codes={}},LGraphNode.prototype.configure=function(a){for(var b in a)if("console"!=b)if("properties"!=b)null!=a[b]&&("object"==typeof a[b]?this[b]&&this[b].configure?this[b].configure(a[b]):this[b]=LiteGraph.cloneObject(a[b],this[b]):this[b]=a[b]);else for(var c in a.properties)this.properties[c]=a.properties[c];for(var d in this.inputs){var e=this.inputs[d];if(e.link&&e.link.length){var f=e.link;"object"==typeof f&&(e.link=f[0],this.graph.links[f[0]]={id:f[0],origin_id:f[1],origin_slot:f[2],target_id:f[3],target_slot:f[4]})}}for(var d in this.outputs){var g=this.outputs[d];if(g.links&&0!=g.links.length)for(var b in g.links){var f=g.links[b];"object"==typeof f&&(g.links[b]=f[0])}}},LGraphNode.prototype.serialize=function(){var a={id:this.id,title:this.title,type:this.type,pos:this.pos,size:this.size,data:this.data,flags:LiteGraph.cloneObject(this.flags),inputs:this.inputs,outputs:this.outputs};return this.properties&&(a.properties=LiteGraph.cloneObject(this.properties)),a.type||(a.type=this.constructor.type),this.color&&(a.color=this.color),this.bgcolor&&(a.bgcolor=this.bgcolor),this.boxcolor&&(a.boxcolor=this.boxcolor),this.shape&&(a.shape=this.shape),this.onSerialize&&this.onSerialize(a),a},LGraphNode.prototype.clone=function(){var a=LiteGraph.createNode(this.type),b=this.serialize();return delete b.id,a.configure(b),a},LGraphNode.prototype.toString=function(){return JSON.stringify(this.serialize())},LGraphNode.prototype.getTitle=function(){return this.title||this.constructor.title},LGraphNode.prototype.getTitleWidth=function(){return this.title_width},LGraphNode.prototype.computeTitleWidth=function(a,b){return a.font=b,this.title_width=this.title?a.measureText(this.title).width+LiteGraph.NODE_TITLE_HEIGHT+5:0,this.size[0]<this.title_width&&(this.size[0]=this.title_width),this.title_width},LGraphNode.prototype.setOutputData=function(a,b){if(this.outputs&&a>-1&&a<this.outputs.length&&this.outputs[a]&&null!=this.outputs[a].links)for(var c=0;c<this.outputs[a].links.length;c++){var d=this.outputs[a].links[c];this.graph.links[d].data=b}},LGraphNode.prototype.getInputData=function(a){return this.inputs&&a<this.inputs.length&&null!=this.inputs[a].link?this.graph.links[this.inputs[a].link].data:null},LGraphNode.prototype.isInputConnected=function(a){return this.inputs?a<this.inputs.length&&null!=this.inputs[a].link:null},LGraphNode.prototype.getInputInfo=function(a){return this.inputs&&a<this.inputs.length?this.inputs[a]:null},LGraphNode.prototype.getOutputInfo=function(a){return this.outputs&&a<this.outputs.length?this.outputs[a]:null},LGraphNode.prototype.isOutputConnected=function(a){return this.outputs?a<this.outputs.length&&this.outputs[a].links&&this.outputs[a].links.length:null},LGraphNode.prototype.getOutputNodes=function(a){if(!this.outputs||0==this.outputs.length)return null;if(a<this.outputs.length){for(var b=this.outputs[a],c=[],d=0;d<b.length;d++)c.push(this.graph.getNodeById(b.links[d].target_id));return c}return null},LGraphNode.prototype.triggerOutput=function(a,b){var c=this.getOutputNode(a);c&&c.onTrigger&&c.onTrigger(b)},LGraphNode.prototype.addOutput=function(a,b,c,d){var e={name:a,type:b,types:c,links:null};if(d)for(var f in d)e[f]=d[f];this.outputs||(this.outputs=[]),this.outputs.push(e),this.onOutputAdded&&this.onOutputAdded(e),this.size=this.computeSize()},LGraphNode.prototype.addOutputs=function(a){for(var b in a){var c=a[b],d={name:c[0],type:c[1],link:null};if(a[2])for(var e in c[2])d[e]=c[2][e];this.outputs||(this.outputs=[]),this.outputs.push(d),this.onOutputAdded&&this.onOutputAdded(d)}this.size=this.computeSize()},LGraphNode.prototype.removeOutput=function(a){this.disconnectOutput(a),this.outputs.splice(a,1),this.size=this.computeSize(),this.onOutputRemoved&&this.onOutputRemoved(a)},LGraphNode.prototype.addInput=function(a,b,c,d){var e={name:a,type:b,link:null,types:c};if(d)for(var f in d)e[f]=d[f];this.inputs||(this.inputs=[]),this.inputs.push(e),this.size=this.computeSize(),this.onInputAdded&&this.onInputAdded(e)},LGraphNode.prototype.addInputs=function(a){for(var b in a){var c=a[b],d={name:c[0],type:c[1],link:null};if(a[2])for(var e in c[2])d[e]=c[2][e];this.inputs||(this.inputs=[]),this.inputs.push(d),this.onInputAdded&&this.onInputAdded(d)}this.size=this.computeSize()},LGraphNode.prototype.removeInput=function(a){this.disconnectInput(a),this.inputs.splice(a,1),this.size=this.computeSize(),this.onInputRemoved&&this.onInputRemoved(a)},LGraphNode.prototype.addConnection=function(a,b,c,d){this.connections.push({name:a,type:b,pos:c,direction:d,links:null})},LGraphNode.prototype.computeSize=function(){var a=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),b=new Float32Array([0,0]);return b[1]=14*a+6,b[0]=this.inputs&&0!=this.inputs.length&&this.outputs&&0!=this.outputs.length?LiteGraph.NODE_WIDTH:.5*LiteGraph.NODE_WIDTH,b},LGraphNode.prototype.getBounding=function(){return new Float32Array([this.pos[0]-4,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,this.pos[0]+this.size[0]+4,this.pos[1]+this.size[1]+LGraph.NODE_TITLE_HEIGHT])},LGraphNode.prototype.isPointInsideNode=function(a,b){var c=this.graph&&this.graph.isLive()?0:20;if(this.flags.collapsed){if(isInsideRectangle(a,b,this.pos[0],this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,this.getTitleWidth(),LiteGraph.NODE_TITLE_HEIGHT))return!0}else if(this.pos[0]-4<a&&this.pos[0]+this.size[0]+4>a&&this.pos[1]-c<b&&this.pos[1]+this.size[1]>b)return!0;return!1},LGraphNode.prototype.findInputSlot=function(a){if(!this.inputs)return-1;for(var b=0,c=this.inputs.length;c>b;++b)if(a==this.inputs[b].name)return b;return-1},LGraphNode.prototype.findOutputSlot=function(a){if(!this.outputs)return-1;for(var b=0,c=this.outputs.length;c>b;++b)if(a==this.outputs[b].name)return b;return-1},LGraphNode.prototype.connect=function(a,b,c){if(c=c||0,a.constructor===String){if(a=this.findOutputSlot(a),-1==a)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+a),!1}else if(!this.outputs||a>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;if(b==this)return!1;if(c.constructor===String){if(c=b.findInputSlot(c),-1==c)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+c),!1}else if(!b.inputs||c>=b.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;-1!=c&&null!=b.inputs[c].link&&b.disconnectInput(c);var d=this.outputs[a];if(-1==c)null==d.links&&(d.links=[]),d.links.push({id:b.id,slot:-1});else if(!d.type||!b.inputs[c].type||d.type==b.inputs[c].type||LiteGraph.compareNodeTypes(d,b.inputs[c])){var e={id:this.graph.last_link_id++,origin_id:this.id,origin_slot:a,target_id:b.id,target_slot:c};this.graph.links[e.id]=e,null==d.links&&(d.links=[]),d.links.push(e.id),b.inputs[c].link=e.id,this.setDirtyCanvas(!1,!0),this.graph.onConnectionChange()}return!0},LGraphNode.prototype.disconnectOutput=function(a,b){if(a.constructor===String){if(a=this.findOutputSlot(a),-1==a)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+a),!1}else if(!this.outputs||a>=this.outputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var c=this.outputs[a];if(!c.links||0==c.links.length)return!1;if(b)for(var d=0,e=c.links.length;e>d;d++){var f=c.links[d],g=this.graph.links[f];if(g.target_id==b.id){c.links.splice(d,1),b.inputs[g.target_slot].link=null,delete this.graph.links[f];break}}else{for(var d=0,e=c.links.length;e>d;d++){var f=c.links[d],g=this.graph.links[f],b=this.graph.getNodeById(g.target_id);b&&(b.inputs[g.target_slot].link=null)}c.links=null}return this.setDirtyCanvas(!1,!0),this.graph.onConnectionChange(),!0},LGraphNode.prototype.disconnectInput=function(a){if(a.constructor===String){if(a=this.findInputSlot(a),-1==a)return LiteGraph.debug&&console.log("Connect: Error, no slot of name "+a),!1}else if(!this.inputs||a>=this.inputs.length)return LiteGraph.debug&&console.log("Connect: Error, slot number not found"),!1;var b=this.inputs[a];if(!b)return!1;var c=this.inputs[a].link;this.inputs[a].link=null;var d=this.graph.links[c],e=this.graph.getNodeById(d.origin_id);if(!e)return!1;var f=e.outputs[d.origin_slot];if(!f||!f.links||0==f.links.length)return!1;for(var g=0,h=f.links.length;h>g;g++){var c=f.links[g],d=this.graph.links[c];if(d.target_id==this.id){f.links.splice(g,1);break}}return this.setDirtyCanvas(!1,!0),this.graph.onConnectionChange(),!0},LGraphNode.prototype.getConnectionPos=function(a,b){return this.flags.collapsed?a?[this.pos[0],this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT]:[this.pos[0]+this.getTitleWidth(),this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT]:a&&-1==b?[this.pos[0]+10,this.pos[1]+10]:a&&this.inputs.length>b&&this.inputs[b].pos?[this.pos[0]+this.inputs[b].pos[0],this.pos[1]+this.inputs[b].pos[1]]:!a&&this.outputs.length>b&&this.outputs[b].pos?[this.pos[0]+this.outputs[b].pos[0],this.pos[1]+this.outputs[b].pos[1]]:a?[this.pos[0],this.pos[1]+10+b*LiteGraph.NODE_SLOT_HEIGHT]:[this.pos[0]+this.size[0]+1,this.pos[1]+10+b*LiteGraph.NODE_SLOT_HEIGHT]},LGraphNode.prototype.alignToGrid=function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)},LGraphNode.prototype.trace=function(a){this.console||(this.console=[]),this.console.push(a),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace(this,a)},LGraphNode.prototype.setDirtyCanvas=function(a,b){this.graph&&this.graph.sendActionToCanvas("setDirty",[a,b])},LGraphNode.prototype.loadImage=function(a){var b=new Image;b.src=LiteGraph.node_images_path+a,b.ready=!1;var c=this;return b.onload=function(){this.ready=!0,c.setDirtyCanvas(!0)},b},LGraphNode.prototype.executeAction=function(a){if(""==a)return!1;if(-1!=a.indexOf(";")||-1!=a.indexOf("}"))return this.trace("Error: Action contains unsafe characters"),!1;var b=a.split("("),c=b[0];if("function"!=typeof this[c])return this.trace("Error: Action not found on node: "+c),!1;var d=a;try{var e=eval;eval=null,new Function("with(this) { "+d+"}").call(this),eval=e}catch(f){return this.trace("Error executing action {"+a+"} :"+f),!1}return!0},LGraphNode.prototype.captureInput=function(a){if(this.graph&&this.graph.list_of_graphcanvas){var b=this.graph.list_of_graphcanvas;for(var c in b){var d=b[c];(a||d.node_capturing_input==this)&&(d.node_capturing_input=a?this:null,this.graph.debug&&console.log(this.title+": Capturing input "+(a?"ON":"OFF")))}}},LGraphNode.prototype.collapse=function(){this.flags.collapsed=this.flags.collapsed?!1:!0,this.setDirtyCanvas(!0,!0)},LGraphNode.prototype.pin=function(a){this.flags.pinned=void 0===a?!this.flags.pinned:a},LGraphNode.prototype.localToScreen=function(a,b,c){return[(a+this.pos[0])*c.scale+c.offset[0],(b+this.pos[1])*c.scale+c.offset[1]]},LGraphNode.prototype.getInputNodes=function(){var a=[];if(!this.inputs||0==this.inputs.length)return a;for(var b=0;b<this.inputs.length;b++){var c=this.inputs[b].link,d=this.graph.links[c];a.push(this.graph.getNodeById(d.origin_id))}return a},LGraphNode.prototype.getInputCode=function(a){var b=this.getInputNodes();return b[a].codes};var LiteGraph={NODE_TITLE_HEIGHT:16,NODE_SLOT_HEIGHT:15,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,CANVAS_GRID_SIZE:10,NODE_TITLE_COLOR:"#222",NODE_DEFAULT_COLOR:"#999",NODE_DEFAULT_BGCOLOR:"#444",NODE_DEFAULT_BOXCOLOR:"#AEF",NODE_SELECTED_COLOR:"#FFF",NODE_DEFAULT_SHAPE:"round",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],node_images_path:"",proxy:null,debug:!1,throw_errors:!0,registered_node_types:{},registerNodeType:function(a,b){if(!b.prototype)throw"Cannot register a simple object, it must be a class with a prototype";b.type=a,LiteGraph.debug&&console.log("Node registered: "+a);var c=(a.split("/"),a.lastIndexOf("/"));if(b.category=a.substr(0,c),b.prototype)for(var d in LGraphNode.prototype)b.prototype[d]||(b.prototype[d]=LGraphNode.prototype[d]);this.registered_node_types[a]=b},createNode:function(a,b,c){var d=this.registered_node_types[a];if(!d)return LiteGraph.debug&&console.log('GraphNode type "'+a+'" not registered.'),null;d.prototype||d;b=b||d.title||a;var e=new d(name);if(e.type=a,e.title||(e.title=b),e.properties||(e.properties={}),e.flags||(e.flags={}),e.size||(e.size=e.computeSize()),e.pos||(e.pos=LiteGraph.DEFAULT_POSITION.concat()),c)for(var f in c)e[f]=c[f];return e},getNodeType:function(a){return this.registered_node_types[a]},getNodeTypesInCategory:function(a){var b=[];for(var c in this.registered_node_types)""==a?null==this.registered_node_types[c].category&&b.push(this.registered_node_types[c]):this.registered_node_types[c].category==a&&b.push(this.registered_node_types[c]);return b},getNodeTypesCategories:function(){var a={"":1};for(var b in this.registered_node_types)this.registered_node_types[b].category&&!this.registered_node_types[b].skip_list&&(a[this.registered_node_types[b].category]=1);var c=[];for(var b in a)c.push(b);return c},reloadNodes:function(a){var b=document.getElementsByTagName("script"),c=[];for(var d in b)c.push(b[d]);var e=document.getElementsByTagName("head")[0];a=document.location.href+a;for(var d in c){var f=c[d].src;if(f&&f.substr(0,a.length)==a)try{LiteGraph.debug&&console.log("Reloading: "+f);var g=document.createElement("script");g.type="text/javascript",g.src=f,e.appendChild(g),e.removeChild(c[d])}catch(h){if(LiteGraph.throw_errors)throw h;LiteGraph.debug&&console.log("Error while reloading "+f)}}LiteGraph.debug&&console.log("Nodes reloaded")},cloneObject:function(a,b){if(null==a)return null;var c=JSON.parse(JSON.stringify(a));if(!b)return c;for(var d in c)b[d]=c[d];return b}};LiteGraph.getTime="undefined"!=typeof performance?function(){return performance.now()}:function(){return Date.now()},CanvasRenderingContext2D.prototype.roundRect=function(a,b,c,d,e,f){return void 0===f||e===f?(2*e>c&&(e=c/2),2*e>d&&(e=d/2),this.beginPath(),this.moveTo(a+e,b),this.arcTo(a+c,b,a+c,b+d,e),this.arcTo(a+c,b+d,a,b+d,e),this.arcTo(a,b+d,a,b,e),this.arcTo(a,b,a+c,b,e),this.closePath(),this):(void 0===e&&(e=5),void 0===f&&(f=e),this.beginPath(),this.moveTo(a+e,b),this.lineTo(a+c-e,b),this.quadraticCurveTo(a+c,b,a+c,b+e),this.lineTo(a+c,b+d-f),this.quadraticCurveTo(a+c,b+d,a+c-f,b+d),this.lineTo(a+f,b+d),this.quadraticCurveTo(a,b+d,a,b+d-f),this.lineTo(a,b+e),this.quadraticCurveTo(a,b,a+e,b),this)},LiteGraph.createContextualMenu=function(a,b,c){function d(a){var c=(this.dataset.value,!0);if(b.callback){var d=b.callback.call(e,this.data,a);void 0!=d&&(c=d)}c&&LiteGraph.closeAllContextualMenus()}b=b||{},this.options=b,c=c||window,b.from||LiteGraph.closeAllContextualMenus();var e=c.document.createElement("div");e.className="litecontextualmenu litemenubar-panel",this.root=e;var f=e.style;f.minWidth="100px",f.minHeight="20px",f.position="fixed",f.top="100px",f.left="100px",f.color="#AAF",f.padding="2px",f.borderBottom="2px solid #AAF",f.backgroundColor="#444",e.addEventListener("contextmenu",function(a){return a.preventDefault(),!1});for(var g in a){var h=a[g],i=c.document.createElement("div");i.className="litemenu-entry",null!=h?(h.is_menu&&(i.className+=" submenu"),h.disabled&&(i.className+=" disabled"),i.style.cursor="pointer",i.dataset.value="string"==typeof h?h:h.value,i.data=h,i.innerHTML="string"==typeof h?a.constructor==Array?a[g]:g:h.content?h.content:g,i.addEventListener("click",d),e.appendChild(i)):(i.className="litemenu-entry separator",e.appendChild(i))}e.addEventListener("mouseover",function(){this.mouse_inside=!0}),e.addEventListener("mouseout",function(a){for(var b=a.toElement;b!=this&&b!=c.document;)b=b.parentNode;b!=this&&(this.mouse_inside=!1,this.block_close||this.closeMenu())}),c.document.body.appendChild(e);var j=e.getClientRects()[0];b.from&&(b.from.block_close=!0);var k=b.left||0,l=b.top||0;if(b.event){k=b.event.pageX-10,l=b.event.pageY-10,b.left&&(k=b.left);var m=c.document.body.getClientRects()[0];if(b.from){var n=b.from.getClientRects()[0];k=n.left+n.width}k>m.width-j.width-10&&(k=m.width-j.width-10),l>m.height-j.height-10&&(l=m.height-j.height-10)}return e.style.left=k+"px",e.style.top=l+"px",e.closeMenu=function(){b.from&&(b.from.block_close=!1,b.from.mouse_inside||b.from.closeMenu()),this.parentNode&&c.document.body.removeChild(this)},e},LiteGraph.closeAllContextualMenus=function(){var a=document.querySelectorAll(".litecontextualmenu");if(a.length){for(var b=[],c=0;c<a.length;c++)b.push(a[c]);for(var c in b)b[c].parentNode&&b[c].parentNode.removeChild(b[c])}},LiteGraph.extendClass=function(a,b){for(var c in b)a.hasOwnProperty(c)||(a[c]=b[c]);if(b.prototype)for(var c in b.prototype)b.prototype.hasOwnProperty(c)&&(a.prototype.hasOwnProperty(c)||(b.prototype.__lookupGetter__(c)?a.prototype.__defineGetter__(c,b.prototype.__lookupGetter__(c)):a.prototype[c]=b.prototype[c],b.prototype.__lookupSetter__(c)&&a.prototype.__defineSetter__(c,b.prototype.__lookupSetter__(c))))},LiteGraph.compareNodeTypes=function(a,b){if(!a.types||!b.types)return!1;for(key in a.types)if(b.types.hasOwnProperty(key))return!0;return!1},LiteGraph.dispatchEvent=function(a,b,c){var d;document.createEvent?(d=document.createEvent("HTMLEvents"),d.initEvent(a,!0,!0)):(d=document.createEventObject(),d.eventType=a),d.eventName=a,d.data=b,c||(c=document),document.createEvent?c.dispatchEvent(d):c.fireEvent("on"+d.eventType,d)},window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}),CodePiece.prototype.getBodyIds=function(){return this.body_ids},CodePiece.prototype.getBody=function(){return this.body_hash},CodePiece.prototype.setBody=function(a){var b=a.hashCode();"undefined"==typeof this.body_hash[b]&&(this.body_hash[b]=a,this.body_ids.unshift(b))},CodePiece.prototype.getHeader=function(){return this.header},CodePiece.prototype.setHeader=function(a){for(var b in a)this.header[b]=1},CodePiece.prototype.addHeaderLine=function(a){this.header[a]=1},CodePiece.prototype.setIncludes=function(a){for(var b in a)this.includes[b]=1},CodePiece.prototype.setOutputVar=function(a){this.output_var=a},CodePiece.prototype.getOutputVar=function(){return this.output_var},CodePiece.prototype.setScope=function(a){this.scope=a},CodePiece.prototype.merge=function(a){for(var b=a.getBodyIds(),c=a.getBody(),d=b.length-1;d>=0;d--)this.setBody(c[b[d]]);for(var e in a.getHeader())this.header[e]=a.header[e];for(var e in a.includes)this.includes[e]=a.includes[e]};var ShaderConstructor={};ShaderConstructor.createShader=function(a){var b=a[0],c=a[1],d=this.createVertexCode(b),e=this.createFragmentCode(c);return console.log("vertex:"),console.log(d),console.log("fragment:"),console.log(e),new GL.Shader(d,e)},ShaderConstructor.createVertexCode=function(a){var b=a.includes,c="            precision highp float;\n			attribute vec3 a_vertex;\n			attribute vec3 a_normal;\n			attribute vec2 a_coord;\n			";b.v_coord&&(c+="varying vec2 v_coord;\n            "),b.v_normal&&(c+="varying vec3 v_normal;\n            "),b.v_pos&&(c+="varying vec3 v_pos;\n            "),b.u_eye&&(c+="uniform vec3 u_eye;\n            "),c+="uniform mat4 u_mvp;\n		    uniform mat4 u_model;\n";for(var d in a.getHeader())c+=d;c+="void main() {\n            ",b.v_pos&&(c+="v_pos = (u_model * vec4(a_vertex,1.0)).xyz;\n            ");for(var e=a.getBodyIds(),f=a.getBody(),g=0,h=e.length;h>g;g++)c+=f[e[g]];return c+="gl_Position = u_mvp * vec4(a_vertex,1.0);\n            }\n			"},ShaderConstructor.createFragmentCode=function(a){var b=a.includes,c="            precision highp float;\n			";b.v_coord&&(c+="varying vec2 v_coord;\n            "),b.v_normal&&(c+="varying vec3 v_normal;\n            "),b.v_pos&&(c+="varying vec3 v_pos;\n            "),b.u_eye&&(c+="uniform vec3 u_eye;\n            ");for(var d in a.getHeader())c+=d;c+="void main() {\n            ";for(var e=a.getBodyIds(),f=a.getBody(),g=0,h=e.length;h>g;g++)c+=f[e[g]];return c+="gl_FragColor = "+a.getOutputVar()+";\n",c+="\n}\n			"};var PCameraToPixelWS={};PCameraToPixelWS.id="cameratopixelws",PCameraToPixelWS.includes={v_pos:1,u_eye:1},PCameraToPixelWS.already_included=!1,PCameraToPixelWS.getVertexCode=function(){var a=new CodePiece;return a.setIncludes(PCameraToPixelWS.includes),a},PCameraToPixelWS.getFragmentCode=function(){var a=new CodePiece;return a.setBody("vec3 camera_to_pixel_ws = normalize(v_pos - u_eye); \n            "),a.setIncludes(PCameraToPixelWS.includes),a.setOutputVar("camera_to_pixel_ws"),a},PCameraToPixelWS.getCode=function(a,b){var c=this.getFragmentCode(a,b),d=this.getVertexCode(a,b);return PCameraToPixelWS.already_included=!0,[d,c]},PConstant.VERTEX=1,PConstant.FRAGMENT=2,PConstant.BOTH=3,PConstant.prototype.getVertexCode=function(a,b){if(b==PConstant.VERTEX||b==PConstant.BOTH){var c=this.type+" "+a+" = "+value+";\n                ";return c}return""},PConstant.prototype.getFragmentCode=function(a,b,c){if(c==PConstant.FRAGMENT||c==PConstant.BOTH){var d=this.type+" "+a+" = "+b+";\n                ";return d}return""},PConstant.prototype.getCode=function(a,b,c){var d=new CodePiece;d.setBody(this.getVertexCode(a,b,c)),d.setIncludes(this.includes);var e=new CodePiece;return e.setBody(this.getFragmentCode(a,b,c)),e.setIncludes(this.includes),e.setOutputVar(a),[d,e]};var PMixer={};PMixer.id="mixer",PMixer.includes={v_pos:1,u_eye:1},PMixer.already_included=!1,PMixer.getVertexCode=function(){return""
},PMixer.getFragmentCode=function(a,b,c,d){return"vec4 "+a+" = mix("+b+","+c+","+d+"); \n            "},PMixer.getCode=function(a,b,c,d){var e=new CodePiece;e.setBody(this.getVertexCode(a,b,c,d)),e.setIncludes(PMixer.includes);var f=new CodePiece;return f.setBody(this.getFragmentCode(a,b,c,d)),f.setIncludes(PMixer.includes),f.setOutputVar(a),PMixer.already_included=!0,[e,f]};var POperation={};POperation.id="operation",POperation.includes={v_pos:1,u_eye:1},POperation.already_included=!1,POperation.getVertexCode=function(){return""},POperation.getFragmentCode=function(a,b,c,d){return"vec4 "+a+" = "+c+" "+b+" "+d+"; \n            "},POperation.getCode=function(a,b,c,d){var e=new CodePiece;e.setBody(this.getVertexCode(a,b,c,d)),e.setIncludes(POperation.includes);var f=new CodePiece;return f.setBody(this.getFragmentCode(a,b,c,d)),f.setIncludes(POperation.includes),f.setOutputVar(a),POperation.already_included=!0,[e,f]};var PPixelNormalWS={};PPixelNormalWS.id="pixel_normal_ws",PPixelNormalWS.includes={u_model:1,a_normal:1,v_normal:1},PPixelNormalWS.already_included=!1,PPixelNormalWS.getVertexCode=function(){var a="v_normal = (u_model * vec4(a_normal, 0.0)).xyz;\n                ";return a},PPixelNormalWS.getFragmentCode=function(){var a="vec3 pixel_normal_ws = v_normal;\n            ";return a},PPixelNormalWS.getCode=function(a,b){var c=new CodePiece;c.setBody(this.getVertexCode(a,b)),c.setIncludes(PPixelNormalWS.includes);var d=new CodePiece;return d.setBody(this.getFragmentCode(a,b)),d.setIncludes(PPixelNormalWS.includes),d.setOutputVar("pixel_normal_ws"),PPixelNormalWS.already_included=!0,[c,d]};var PReflect={};PReflect.id="reflect",PReflect.includes={},PReflect.getVertexCode=function(){return""},PReflect.getFragmentCode=function(a,b,c){var d="vec3 "+a+"= reflect("+b+","+c+");\n            ";return d},PReflect.getCode=function(a,b,c){var d=new CodePiece;d.setIncludes(PReflect.includes);var e=new CodePiece;return e.setBody(this.getFragmentCode(a,b,c)),e.setIncludes(PReflect.includes),e.setOutputVar(a),[d,e]};var PTextureSampleCube={};PTextureSampleCube.id="texture_sample_cube",PTextureSampleCube.includes={},PTextureSampleCube.getVertexCode=function(){return""},PTextureSampleCube.getFragmentCode=function(a,b,c){if(!b)throw"input for sample cube not defined";var d="vec4 "+a+" = textureCube("+c+", "+b+");\n                ";return d},PTextureSampleCube.getCode=function(a,b,c){var d=new CodePiece;d.setIncludes(PTextureSampleCube.includes);var e=new CodePiece;return e.setBody(this.getFragmentCode(a,b,c)),e.addHeaderLine("uniform samplerCube "+c+";\n      "),e.setIncludes(PTextureSampleCube.includes),e.setOutputVar(a),[d,e]};var PTextureSample={};PTextureSample.id="texture_sample",PTextureSample.includes={},PTextureSample.getVertexCode=function(){return""},PTextureSample.getFragmentCode=function(a,b,c){b=b||"v_coord";var d="vec4 "+a+" = texture2D("+c+", "+b+");\n                ";return d},PTextureSample.getCode=function(a,b,c){var d=new CodePiece;d.setIncludes(PTextureSample.includes);var e=new CodePiece;return e.setBody(this.getFragmentCode(a,b,c)),e.addHeaderLine("uniform sampler2D "+c+";\n      "),e.setIncludes(PTextureSample.includes),e.setOutputVar(a),[d,e]};var PUVs={};PUVs.id="uvs",PUVs.includes={a_coord:1,v_coord:1},PUVs.already_included=!1,PUVs.getVertexCode=function(){return"v_coord = a_coord;\n            "},PUVs.getFragmentCode=function(){return""},PUVs.getCode=function(a,b){var c=new CodePiece;c.setIncludes(PUVs.includes),c.setOutputVar("v_coord");var d=new CodePiece;return d.setBody(this.getVertexCode(a,b)),d.setIncludes(PUVs.includes),PUVs.already_included=!0,[d,c]};